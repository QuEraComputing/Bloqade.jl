# Hamiltonians

Hamiltonian encodes essential physical properties of Rydberg systems. One can use a Hamiltonian to 
understand the ground state properties of the corresponding Rydberg system and to generate interesting quantum dynamics. 
The Rydberg Hamiltonian is generally specified by atom positions, Rabi frequencies and detunings. In Bloqade, 
we can easily create a Hamiltonian by inputting these information, i.e. lattice and strengths of Rabi frequencies and
detunings,  into the function [`rydberg_h`](@ref). Furthermore, by inputing waveforms for the Rabi frequency and 
detuning, we can easily generate time-dependent Hamiltonians. 


## Building Time-Independent Hamiltonians

To specify the Hamiltonian, we first need to specify the atom positions, which determine the Rydberg intearctions strengths
between pairs of atoms. Here we generate a square lattice by using the code below. 
```@repl hamiltonian
using Bloqade
atoms = generate_sites(SquareLattice(), 3, 3, scale=6.3);
```
Please refer to [Lattice](@ref) page for more details about generating lattice and relevant operations. 

Then the Hamiltonian can be simply built by inputing the generated atom positions `atoms` and by specifying the strength of Rabi
detuning `Δ`, Rabi frequency `Ω`, and laser phase `ϕ`

```@repl hamiltonian
h0 = rydberg_h(atoms; Δ=1.2, Ω=1.1, ϕ=2.1)
```


## Building Time-Dependent Hamiltonians

One can also directly use waveforms (instead of contanst values of detuning, Rabi frequency, and laser phase) to build a time-dependent Hamiltonian. 
First let us use the  [`generate_sites`](@ref) to create a list of atom coordinates. 

```@repl hamiltonian
atoms = generate_sites(ChainLattice(), nsites, scale=5.72)
```

Then we generate time-dependent pulses for ``\Omega`` and ``\Delta`` by using 
[`piecewise_linear`](@ref). For details about how to build waveforms, please refer to the section [Waveforms](@ref). 
```@repl hamiltonian
Ω1 = piecewise_linear(clocks=[0.0, 0.1, 2.1, 2.2], values=[0.0, 6.0, 6.0, 0]);
Δ1 = piecewise_linear(clocks=[0.0, 0.6, 2.1, 2.2], values=[-10.1, -10.1, 10.1, 10.1]);
```

The time-dependent Hamiltonian is easily generated by inputting the waveforms into the function [`rydberg_h`](@ref)

```@repl hamiltonian
h1 = rydberg_h(atoms; Δ=Δ1, Ω=Ω1)
```

By specifying the time of `h1`, we can  acess the Hamiltonian at a particular time, e.g. 

```@repl hamiltonian
ht= h1(0.5)
```

## Hamiltonian Expressions

Inside this package, a more general definition of hamiltonians
are supported as Symbolic expressions, this
gives users the flexiblity to define various different kind of
Hamltonian by simply writing down the expression.

Currently, there are currently 4 terms supported: [`RydInteract`](@ref),
[`XTerm`](@ref), [`NTerm`](@ref), [`ZTerm`](@ref). Instead of using the function [`rydberg_h`](@ref), 
we can also explicitly add up these terms to compose a new hamiltonian, e.g

```@repl hamiltonian
using Bloqade
h = XTerm(5, 1.0) + ZTerm(5, 1.0)
```


## Convert Hamiltonian to Matrices


In order to better understand physical properties (such as engenstate properties and eigenvalue statistics) of a Rydberg system, we may want to diagonalize the corresponding Hamiltonian 
matrices. In Bloqade, the Hamiltonian expression can be converted to a matrice
via type conversion, e.g we can convert the above Hamiltonian
to a `SparseMatrixCSC`

```@repl hamiltonian
using SparseArrays
h_m = SparseMatrixCSC(ht)
```

With strong interactions, only one Rydberg excitation is allowed within the Blockade regime (see [blockade](@ref)). In such a case, the allowed Hilbert space (called blockade subpace) for ``N`` atoms 
is only part of full ``2^N`` Hilbert space. In this case, it is better to work in the blockade subspace such that one can access larger systems. 
One of the essential feature of Bloqade is to allow the users to also work in blockade subspace. Here, we can easily convert the Hamiltonian expression into a matrices in subspace basis.
First, we can specify such a subspace by using function [`blockade_subspace`](@ref), e.g. 

```@repl hamiltonian
space = blockade_subspace(atoms, 7.5)
```
The above code means that the blocakde subspace only includes states where there is only one Rydberg excitation 
within the distance of ``7.5 \mu m``. If we have a chain of atoms seperated by ``5.72 \mu m``, the blocakde subspace 
does not contains states with nearest-neighbour atoms being simutaniously excited. 


Once we have defined the space, we can convert the Hamiltonain to matrice in subspace basis via the codes below
```@repl hamiltonian
h_s= SparseMatrixCSC(ht, space)
```
We can see that the size of the matrices in blockade susbpace is much smaller than that in the full space. 

After the conversion, the Hamiltonian can be diagonalized by using `KrylovKit.eigsolve`
```@repl hamiltonian
using KrylovKit
vals, vecs, info = KrylovKit.eigsolve(h_m,  1, :SR)
```
where the `vals` and `vecs` store calculated eigenvalues and eigenvectors respectively. 